---
title: "Inferential Data Analysis"
author: "Ian Dinwoodie"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(car)
knitr::opts_chunk$set(echo=TRUE)
```

# Loading the Data

Load the raw data and verify its dimensions and structure.

```{r}
df <- readRDS('../data/tidy.Rds')
dim(df)
str(df)
```

# Control vs Experimental Group

## Overview

The first question we wanted to answer was if training at a young age (i.e.,
puppy training) would have an impact on the likelihood of a dog having certain
behavior problems. The behavior problems we are exploring are:

- Aggression
- Barking (excessively)
- Compulsion
- Coprophagia
- Destructive behavior
- Escaping/running away
- Fear/anxiety
- House soiling
- Hyperactivity/overactivity
- Mounting
- Problematic jumping
- Rolling in repulsive materials

We initialize a vector to hold these outcomes.

```{r}
outcomes <- c(
  'aggression',
  'fear_anxiety',
  'jumping',
  'barking',
  'coprophagia',
  'compulsion',
  'house_soiling',
  'rep_materials',
  'hyperactive',
  'destructive',
  'escape',
  'mounting'
)
outcomes <- sort(outcomes)
```

## Fischer Exact

We check for correlation between the predictor (attending puppy training) and
each outcome (the presence of a specific behavior problem). Here we perform the
Fisher Exact test with a Benjamini-Hochberg correction.

```{r}
pred <- 'train_6mo_or_less'

idx <- NULL
p_values <- NULL
odds_ratios <- NULL 
for (outcome in outcomes) {
  tbl <- table(df[, pred], df[, outcome], dnn=c(pred, outcome))
  fisher <- fisher.test(tbl)
  idx <- c(idx, outcome)
  p_values <- c(p_values, fisher$p.value)
  odds_ratios <- c(odds_ratios, fisher$estimate[[1]])
}

# Correct for the possibility of Type I errors.
p_values <- p.adjust(p_values, method='BH')

# Form a result data frame.
df_out <- data.frame(outcome=idx, p_value=p_values,
                     odds_ratio=odds_ratios)

add_sig_columns <- function(df) {
  df$level <- ''
  df[df$p_value <= .05, 'level'] <- '*'
  df[df$p_value <= .01, 'level'] <- '**'
  df[df$p_value <= .001, 'level'] <- '***'
  
  df$dir <- ''
  df[df$odds_ratio < 1, 'dir'] <- '-'
  df[df$odds_ratio > 1, 'dir'] <- '+'
  
  return (df)
}

df_out <- add_sig_columns(df_out)
print(knitr::kable(df_out))
```

So we see that there appears to be an impact from the puppy training, but this
fails to account for other factors that might be at play.

## Binary Logistic Regression

Let's consider what factors may also come in to play:

- Age
- Sex
- Neuter status
- Acquistion of the dog at 12 w.o. or less

```{r}
pred <- 'train_6mo_or_less'
glm_attribs <- c(
  'age_yrs',
  'male',
  'neutered',
  'acq_12_wo_or_less'
)
for (outcome in outcomes) {
  cat(paste(replicate(80, '-'), collapse=''))
  cat(paste0('\n', outcome, '\n'))
  f <- as.formula(paste0(outcome, '~', '.'))
  glm_fit <- glm(f, data=df[,c(outcome, pred, glm_attribs)], family='binomial')
  print(summary(glm_fit))
  print(exp(cbind(OR=coef(glm_fit), suppressMessages(confint(glm_fit)))))
  cat('\nVIF:\n')
  print(car::vif(glm_fit))
  cat('\n')
}
```

# Investigating Training Specifics

At this point we have identified that puppy training has a significant impact on
certain behavior problems. Now we want to investigate the impact of certain
training factors.

## Isolating the Experimental Data Set

First, we isolate the experimental group (those who attended puppy training) in
to their own data set.

```{r}
df_exp <- df %>%
  filter(train_6mo_or_less == TRUE)
summary(df_exp)
```

## Binary Logistic Regression

We want to answer the following questions about the training:

- Did training in the 1-3 month period produce a better outcome than the 4-6
month period?
- Did training technique (reward vs. punishment) have an impact on the
outcome?
- Did the choice of restraining device have an impact on the outcome?

### Preparation

# TODOS

- Were younger dogs more likely (with statistical significance) to attend more sessions?


