---
title: "Building Tidy Data"
author: "Ian Dinwoodie"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggpubr)
knitr::opts_chunk$set(echo=TRUE)
```

# Loading the Data

Load the raw data and verify its dimensions and structure.

```{r}
df <- readRDS('../data/tidy.Rds')
dim(df)
str(df)
```

# Pre-exploration Adjustments

## Training Methods

It is possible that the training technique that participants have reported
(e.g., reward-based training) is at odds with the training devices that were
employed.

```{r}
devices <- c(
  'buckle_collar',
  'martingale',
  'slip_collar',
  'shock_collar',
  'harness',
  'head_halter',
  'choke_collar',
  'prong_collar'
)

plot_list <- list()
for (i in 1:length(devices)) {
  p <- ggplot(data=subset(df, !is.na(train_technique)),
              aes_string(x=devices[i],fill='train_technique')) +
    geom_bar() +
    theme(legend.position="none")
  plot_list[[i]] <- p
}
ggarrange(plotlist=plot_list, ncol=3, nrow=3, common.legend=TRUE,
          legend="bottom")
```

The plot of the martingale usage is a good example of the anticipated trend:
several participants using a punishment-based device have indicated reward-based
training. Let's calculate the number of dogs subjected to a punishing device
when their owner believed they were using reward based training and apply the
necessary adjustments.

```{r}
print('Training techniques:')
summary(df$train_technique)
cnt <- count(df$train_technique)[2,2]

df <- df %>%
  mutate(adj_train_technique = factor(ifelse(
    is.na(train_technique), NA, ifelse(
      martingale | slip_collar | shock_collar | choke_collar | prong_collar,
      'punish', 'reward'))))

print('Training techniques (adjusted):')
summary(df$adj_train_technique)

diff <- cnt - count(df$adj_train_technique)[2,2]
print(paste('Delta:', diff))
```

Let's reconstruct the plot above to visually see the adjustment.

```{r}
plot_list <- list()
for (i in 1:length(devices)) {
  p <- ggplot(data=subset(df, !is.na(adj_train_technique)),
              aes_string(x=devices[i],fill='adj_train_technique')) +
    geom_bar() +
    theme(legend.position="none")
  plot_list[[i]] <- p
}
ggarrange(plotlist=plot_list, ncol=3, nrow=3, common.legend=TRUE,
          legend="bottom")
```
We can see that the employment of a device that punishes is reflected in the
training technique.

## Owner Identifier

The owner identifier is used to calculate the number of owners.

```{r}
# Number of unique owners after inclusion criteria.
length(unique(df$owner_id))
```

It is also used to calculate the number of dogs per household.

```{r}
summary(plyr::count(df, 'owner_id'))
```

Now we can drop the column so to simply the data set.

```{r}
df <- subset(df, select=-c(owner_id))
```

# Basic Exploration

## Overview of Data Set

We start with an overview of the data we are working with.

```{r}
summary(df)
```

## Continuous Variables

The age of the dog is the only continuous variable we are working with.

```{r}
plot(df[1:6])
```

```{r}
ggplot(df, aes_string(x='age_yrs', fill='train_6mo_or_less')) +
    geom_bar() +
    labs(title='Frequency of Early Training vs Age in Years', x='Age (years)',
         y='Frequency', fill='Early Training') +
    theme(plot.title = element_text(hjust = 0.5))
```

# Saving the Exploratory Data

Save the data to a file in RDS format so that the data types are saved and so
that the output is compressed.

```{r}
saveRDS(df, '../data/exploratory.Rds')
```
