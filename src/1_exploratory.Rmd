---
title: "Building Tidy Data"
author: "Ian Dinwoodie"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggpubr)
library(GGally)
library(e1071) 
knitr::opts_chunk$set(echo=TRUE)
```

# Loading the Data

Load the raw data and verify its dimensions and structure.

```{r}
df <- readRDS('../data/tidy.Rds')
dim(df)
str(df)
```

# Accounting for the Human-Factor

## Training Methods

It is possible that the training technique that participants have reported
(e.g., reward-based training) is at odds with the training devices that were
employed.

```{r}
devices <- c(
  'buckle_collar',
  'martingale',
  'slip_collar',
  'shock_collar',
  'harness',
  'head_halter',
  'choke_collar',
  'prong_collar'
)

plot_list <- list()
for (i in 1:length(devices)) {
  p <- ggplot(data=subset(df, !is.na(train_technique)),
              aes_string(x=devices[i],fill='train_technique')) +
    geom_bar() +
    theme(legend.position="none")
  plot_list[[i]] <- p
}
ggarrange(plotlist=plot_list, ncol=3, nrow=3, common.legend=TRUE,
          legend="bottom")
```

The plot of the martingale usage is a good example of the anticipated trend:
several participants using a punishment-based device have indicated reward-based
training. Let's calculate the number of dogs subjected to a punishing device
when their owner believed they were using reward based training and apply the
necessary adjustments.

```{r}
print('Training techniques:')
summary(df$train_technique)
cnt <- summary(df$train_technique)[2]

df <- df %>%
  mutate(adj_train_technique = factor(ifelse(
    is.na(train_technique), NA, ifelse(
      martingale | slip_collar | shock_collar | choke_collar | prong_collar,
      'punish', 'reward'))))

print('Training techniques (adjusted):')
summary(df$adj_train_technique)

diff <- cnt - summary(df$adj_train_technique)[2]
print(paste('Delta:', diff))
```

Let's reconstruct the plot above to visually see the adjustment.

```{r}
plot_list <- list()
for (i in 1:length(devices)) {
  p <- ggplot(data=subset(df, !is.na(adj_train_technique)),
              aes_string(x=devices[i],fill='adj_train_technique')) +
    geom_bar() +
    theme(legend.position="none")
  plot_list[[i]] <- p
}
ggarrange(plotlist=plot_list, ncol=3, nrow=3, common.legend=TRUE,
          legend="bottom")
```
We can see that the employment of a device that punishes is reflected in the
training technique.

## Owner Identifier

The owner identifier is used to calculate the number of owners.

```{r}
# Number of unique owners after inclusion criteria.
length(unique(df$owner_id))
```

It is also used to calculate the number of dogs per household.

```{r}
summary(plyr::count(df, 'owner_id'))
```

We see the median number of dogs per household is 1 (range: 1 to 8). Now we can
drop the column to simply the data set.

```{r}
df <- subset(df, select=-c(owner_id))
```

# Basic Exploration

## Overview of Data Set

Before we look at the data, let's add a basic behavior problem indicator column.

```{r}
df <- df %>%
  mutate(behav_problem = ifelse(
    aggression | fear_anxiety | jumping | barking | coprophagia | compulsion
    | house_soiling | rep_materials | hyperactive | destructive | escape
    | mounting, TRUE, FALSE))

summary(df$behav_problem)
```

Let's take a look at the data set as we head toward analysis.

```{r}
summary(df)
```

Notable observations:

* Median dog age is 7 yrs (range: 1 to 19 yrs).
  * More than half (54.4%) were acquired at 12 weeks or less.
* A majority (87.1%) of dogs were neutered.
* The gender split is nearly even with 48.6% males.
* About half of the dogs (48.3%) attended training at 6 months old or earlier
(i.e., puppy training).
  * About half (47.4%) of which started attending in the 1-3 month range.
  * A majority (87.4%) of the dogs that attended puppy training were subject to
  some form of restraining device.
    * The buckle collar was the most popular device at 47.6% usage.
    * The shock collar was the least popular at 1.8% usage.
  * A vast majority (89.1%) were believed to have been subjected to reward-based
  training.
    * Correcting for punishing restraint devices, only 64.0% were truly subject
    to reward based training; a 25.1% difference!
* A vast majority of dogs (99.3%) were reported to exhibit at least one type of
problematic behavior.
  * The top 3 most frequent behavior problems were fear/anxiety, aggression, and
  rolling in repulsive materials.
  * The 3 least frequent behavior problems were hyperactivity, destruction, and
  mounting.

We create pairwise scatter plots for columns that all participants were
presented (i.e., no NA responses) and we exclude the individual behavior problem
columns for brevity.

```{r, fig.height=5, fig.width=5}
df %>%
  ggpairs(columns=c('acq_12_wo_or_less', 'age_yrs', 'neutered',
                    'train_6mo_or_less', 'male'),
          mapping=ggplot2::aes(color=behav_problem),
          diag=list(discrete='barDiag',
                    continuous=wrap('densityDiag', alpha=0.5)),
          legend=1,
          progress=FALSE) +
  theme(legend.position='bottom')
```

Our control group consists of the dogs that did not attend puppy training. We
can compare variable distributions across the experimental and control groups by
looking at the graphs along the `train_6mo_or_less` row. Thankfully, we see that
the distributions between the two groups for the plotted columns are roughly
equivalent.

## Continuous Variables

The age of the dog is the only continuous variable we are working with.

```{r}
ggplot(df, aes(age_yrs)) + geom_bar(fill='steelblue')
skewness(df$age_yrs)
```

We see a slight right skew in the plot. Let's try to center it by applying a log
transform.

```{r}
df <- df %>%
  mutate(log_age_yrs = log(age_yrs))
ggplot(df, aes(log_age_yrs)) + geom_bar(fill='steelblue')
skewness(df$log_age_yrs)

df <- subset(df, select=-c(log_age_yrs))
```

We see that the log transform resulted in a greater absolute skew, so we drop
the transformed column and rely on the original.

## Discrete Variables

```{r, fig.height=5, fig.width=5}
discrete <- c(
  'acq_12_wo_or_less',
  'neutered',
  'train_6mo_or_less',
  'male',
  'behav_problem',
  'aggression',
  'fear_anxiety',
  'jumping',
  'barking',
  'coprophagia',
  'compulsion',
  'rep_materials',
  'hyperactive',
  'destructive',
  'escape',
  'mounting',
  'house_soiling'
)

plot_list <- list()
for (i in 1:length(discrete)) {
  p <- ggplot(df, aes_string(x=discrete[i])) +
    geom_bar() +
    theme(legend.position="none")
  plot_list[[i]] <- p
}
ggarrange(plotlist=plot_list, ncol=4, nrow=5, common.legend=TRUE,
          legend="bottom")
```

# Exploring Trends and Relationships

We are investigating whether or not taking a puppy to training within the first
six months has an effect on their overall outcome. So we start by visualizing
the difference between attending and not attending puppy training for each
attribute and outcome variable. We look at the attributes to see how fairly the
two groups are split. We look at the outcomes to see if a visually distinct
effect.

```{r}
# Generate plots for each attribute split by a simple predictor.
pred <- 'train_6mo_or_less'
attribs <- c(
  'age_yrs',
  'male',
  'neutered',
  'train_age',
  'train_technique',
  'train_class_count'
)
attribs <- sort(attribs)

plot_list <- list()
for (i in 1:length(attribs)) {
  p <- ggplot(df, aes_string(x=attribs[i], fill=pred)) +
    geom_bar() +
    theme(legend.position="none")
  plot_list[[i]] <- p
}
ggarrange(plotlist=plot_list, ncol=3, nrow=2, common.legend=TRUE,
          legend="bottom")
```

In the plots above the value of "NA" for the training age corresponds to (1) the
dog did not attend puppy training or (2) the owner was not sure if the dog
attended puppy training.

# Saving the Exploratory Data

Save the data to a file in RDS format so that the data types are saved and so
that the output is compressed.

```{r}
saveRDS(df, '../data/exploratory.Rds')
```
